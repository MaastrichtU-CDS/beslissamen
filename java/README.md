# Beslissamen backend

Backend for beslissamen.nl with an API for patient tracking.

## Configuration

External configuration can be made in the application.yml or application-prod.yml (production profile), which has to be located next to the jar.

Configuration order [(spring docs)](https://docs.spring.io/spring-boot/docs/current/reference/html/boot-features-external-config.html) 
* External configuration overwrites internal configuration
* Profile specific configuration overwrites non-profile specific configuration

Active profile can be set in the application.yml 

    spring.profiles.active=prod

or as an argument:

    --spring.profiles.active=prod

Run the jar as a java application.

    java -jar <beslissamen><version>.jar 
 
### Logging

    logging:
      file: beslis-samen-backend.log
      level:
        nl.maastro: INFO

### Database
    
    spring:
      datasource:
        url: jdbc:h2:file:./db/beslissamen;DB_CLOSE_DELAY=-1
        username: beslissamen
        password: AblexaVerEsT
      jpa:
        hibernate.ddl-auto: update

Configure a postgres database

    spring:
      datasource:
        url: jdbc:postgresql://localhost:5432/beslissamen         
        
Run a docker postgres database using docker compose:        
        
    docker-compose -f /src/main/docker/postgresql.yml up     

### Frontend backend url

Configure the backend url in the frontend js-file "samenbeslissen-website-pdas\pda\borst\rt\launch.service.js" __(frontend repository)__, 
set the url of backend (this application).
  
    var beslisSamenBackend = "http://localhost:8081";


### CORS

Next, configure the origin in the backend "application.yml", to share the backend resources with the frontend.

    cors.allowed-origins:
        - http://beslissamen.nl
        - https://beslissamen.nl

__Development note:__ For development on Windows Apache Web Server [Apache 2.4 VC15 Windows Binaries and Modules](https://www.apachelounge.com/download/) is used to serve the frontend content, default it serves on "http://localhost" which is configured as cors allowed origins in the dev profile.
       
    cors.allowed-origins:
        - http://localhost 
        
### Security of endpoints

The following endpoints are secured:

   * /swagger-ui.html
   * /admin.html
   * /api/session/csv

Configure credentials (username and password):

    security:
        user:
          name: beslissamen
          password: AblexaVerEsT


## Admin guide

This backend tracks users of the following PDAs:

 * pda_borstradiotherapie_nl

Administrators can use an admin page <backend-url>/admin.html, credentials have to be provided.
Credentials are configured as described in section "Security of endpoints". 

### Patient login codes
The patient logins which are required for some selected PDAs, have to be provided by the medical practicioner. 
Login codes can be generated using the admin page "Generate new login code".

### CSV export
Sessions of the users are tracked. Session information can be downloaded as a csv using the admin page "Download CSV export".

## Test Case

1. Navigate to beslissamen.nl
2. Select "Borstkanker keuzehulp" followed by "Borstkanker radiotherapie"
3. Accept "voorwaarden" and press "Continue"
4. "Keuzehulp inlogvenster" invalid codes:
    
    a. __without code__ and continue "Ga verder": error message "Inlogcode is ongeldig. Probeer opnieuw of neem contact op met uw behandelend arts."
    
    b. __invalid code__ and continue "Ga verder": error message "Inlogcode is ongeldig. Probeer opnieuw of neem contact op met uw behandelend arts."

5. Use the backend "Administration page" on <backend-url><port>/admin.html to "Generate new login code"
6. "Keuzehulp inlogvenster" provide __valid generated code__ and continue "Ga verder": the PDA is started
7. Use the PDA
8. Use the backend "Administration page" on <backend-url><port>/admin.html to "Download CSV export"
9. The CSV should contain session tracking of the login generated by this test case